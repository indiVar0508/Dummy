name: Test

on:
  workflow_dispatch:
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: [3.8]

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: "0"
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python }}
      - name: Install Tox and any other packages
        run: pip install .[test]
      - name: manually triggered tests
        if: |
          github.event_name == 'workflow_dispatch'
        run: PYTHONPATH='.' coverage run --data-file=saved_coverage/indi_dummy/.coverage --branch -m pytest tests/
      - uses: actions/upload-artifact@v3
        if: |
          github.event_name == 'workflow_dispatch'
        with:
          name: coverage
          path: saved_coverage/indi_dummy/.coverage
          if-no-files-found: error
      - uses: dawidd6/action-download-artifact@v2
        if: |
          github.event_name != 'workflow_dispatch'
        with:
          branch: master
          name: coverage
          path: saved_coverage/indi_dummy/
          if_no_artifact_found: fail
      - name: Execute partial tests
        if: |
          github.event_name != 'workflow_dispatch'
        run: |
          partialtest --coverage-dir saved_coverage --project-name indi_dummy --compare-to-branch origin/master --git-diff-use-head --line-coverage
